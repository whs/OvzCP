{% extends "base.html" %}
{% block javascript %}
function editweb(){
	window.location.hash = "webedit"
	$("#webedit").dialog({modal: true, title: "Web forward", width: "75%", height: 400, close: function(x,y){
		window.location.hash = ""
		window.location.reload()
	}});
}
function restartVarnish(){
	if(!confirm("Restart reverse proxy")) return;
	$("#varnishRestartButton").attr("disabled", true);
	$.get("/varnishRestart", {"_xsrf": "{{xsrf}}", veid: "{{veid}}", state: 0}, function(d){
		if(d){ alert(d); return; }
		$.get("/varnishRestart", {"_xsrf": "{{xsrf}}", state: 1}, function(){
			alert("Varnish is being restarted. Please be patience, every sites may not be accesible for few seconds.");
		})
	});
}
$(function(){
	if(window.location.hash == "#webedit"){
		editweb();
	}
});
{% endblock %}
{% block body %}
<div id="bighead">{{vz.hostname}} ({{veid}})</div>
<div id="subhead">{% if vz.running %}Running{% else %}Stopped{% endif %}</div>
<ul>
{% if vz.running %}
	<li><a href="/restart?veid={{vz.veid}}" onclick="return confirm('Restart {{vz.veid}}?')" title="Restart {{vz.veid}}"><img src="{{static_url('restart.png')}}" / > Restart</a></li>
	<li><a href="/stop?veid={{vz.veid}}" onclick="return confirm('Stop {{vz.veid}}?')" title="Stop {{vz.veid}}"><img src="{{static_url('poweroff.png')}}" /> Stop</a></li>
{% else %}
	<li><a href="/start?veid={{vz.veid}}" onclick="return confirm('Start {{vz.veid}}?')" title="Start {{vz.veid}}"><img src="{{static_url('start.png')}}" /> Start</a></li>
	<li><a href="" title="Destroy all data on {{vz.veid}}. Note that there are no backup made and <b>IRREVERSIBLE</b>."><img src="{{static_url('destroy.png')}}" /> Destroy</a></li>
{% endif %}
	<li><a href="#" onclick="editweb(); return false" title="Forward HTTP application port to port 80 on specified hostname.">Web forward</a></li>
	<li><a href="#" onclick="editip(); return false" title="Forward port on an interface">Port forward</a></li>
</ul>
<h1>Billing</h1>
<p>(All calculations are rounded up)</p>
<table>
<thead>
	<tr><th>Kind</th><th>Price ({{unit}})</th></tr>
</thead>
<tbody>
	<tr><td><div title="Every VM created must paid this amount.">Per VM</div></td><td>{{billing['perVM']}}</td></tr>
	<tr><td><div title="{{config.get("billing", "memory")}} {{unit}} per {{config.get("billing", "memoryPer")}} MB">Memory</div></td><td>{{billing['memory']}}</td></tr>
	<tr><td><div title="{{config.get("billing", "disk")}} {{unit}} per {{config.get("billing", "diskPer")}} MB">Disk</div></td><td>{{billing['disk']}}</td></tr>
	<tr><th>Total</th><td>{{billing['total']}}</td></tr>
</tbody>
</table>
<h1>Data</h1>
<table>
<thead>
	<tr><th>Data</th><th>Value</th></tr>
</thead>
<tbody>
	<tr><td><div title="Internal IP of this VM. Every other VM running in the same machine can access this IP so you have to keep ports secure.">IP</div></td><td>{{vz.ip}}</td></tr>
	<tr><td><div title="OS template used to create this VM">OS</div></td><td>{{vz.os|capitalize}}</td></tr>
	<tr><td><div title="How many space your VM can use. Note that you might able to exceed this capacity temporary.">Disk Capacity</div></td><td>{{(vz.diskinfo[0]*1000)|filesizeformat}}</td></tr>
{% if vz.running %}
	<tr><td><div title="How long does this VM have been started">Uptime</div></td><td><div class="time">{{vz.uptime}}</div></td></tr>
	<tr><td>Load average</td><td><span title="5 minute">{{vz.loadAvg[0]}}</span> <span title="10 minute">{{vz.loadAvg[1]}}</span> <span title="15 minute">{{vz.loadAvg[2]}}</span></td></tr>
	<tr><td><div title="The more process, the slower your machine">Process count</div></td><td>{{vz.nproc}}</td></tr>
{% endif %}
	<tr><th colspan="2">Memory</th></tr>
	<tr><td><div title="Guaranteed memory limit how much memory your application may use. If it's full you might still able to run it in burstable memory.">Guaranteed</div></td><td>{{vz.memlimit[0]|filesizeformat}}</td></tr>
	<tr><td><div title="Burstable memory is maximum limit. You application may use these memory but if other VM that haven't reach its guaranteed memory need to use memory, your application will be terminated.">Burstable</div></td><td>{{vz.memlimit[1]|filesizeformat}}</td></tr>
</tbody>
</table>
{% if vz.running %}
<h1>Graph</h1>
{% set memused=vz.meminfo['MemTotal']-vz.meminfo['MemFree'] %}
{% if memused < vz.memlimit[0] %}
<img src="http://chart.apis.google.com/chart?cht=p3&amp;chs=500x200&amp;chtt=Memory usage for {{veid}} ({{vz.meminfo['MemTotal']|filesizeformat}})&amp;chl=Used {{memused|filesizeformat}}|Free {{vz.meminfo['MemFree']|filesizeformat}}&amp;chd=t:{{memused}},{{vz.meminfo['MemFree']}}&amp;chds=0,{{vz.meminfo['MemTotal']}}" />
{% else %}
<img src="http://chart.apis.google.com/chart?cht=p3&amp;chs=500x200&amp;chtt=Memory usage for {{veid}} ({{vz.meminfo['MemTotal']|filesizeformat}})&amp;chl=Guaranteed Used {{vz.memlimit[0]|filesizeformat}}|Burst {{(memused-vz.memlimit[0])|filesizeformat}}|Free {{vz.meminfo['MemFree']|filesizeformat}}&amp;chd=t:{{vz.memlimit[0]}},{{memused-vz.memlimit[0]}},{{vz.meminfo['MemFree']}}&amp;chds=0,{{vz.meminfo['MemTotal']}}" />
{% endif %}
<img src="http://chart.apis.google.com/chart?cht=p3&amp;chs=500x200&amp;chtt=Disk usage for {{veid}} ({{(vz.diskinfo[0]*1000)|filesizeformat}})&amp;chl=Used {{(vz.diskinfo[1]*1000)|filesizeformat}}|Free {{(vz.diskinfo[2]*1000)|filesizeformat}}&amp;chd=t:{{vz.diskinfo[1]}},{{vz.diskinfo[2]}}&amp;chds=0,{{vz.diskinfo[0]}}" />
{% endif %}
<div id="webedit" style="display: none;">
Wildcard forwarding will forward anything.yourdomain.com to yourdomain.com.<br />
After edit changes will <b>NOT</b> be visible until you click <button onclick="restartVarnish()" id="varnishRestartButton">restart proxy</button>. (Every site, including this may not be accessible for few seconds)
Note that you can restart the proxy once only five minutes.
<form style="margin-top: 10px;" action="/addweb" method="post">
{{ xsrf_form_html() }}
<input type="hidden" name="veid" value="{{veid}}" />
<table>
<thead>
	<tr><th>Domain</th><th>Port</th><th>Wildcard</th><th>Action</th></tr>
</thead>
<tbody>
{% for i in vm.varnishBackend %}
{% for i2 in i.cond %}
	<tr><td><a href='http://{{i2.hostname}}'>{{i2.hostname}}</a></td><td>{{i.port}}</td><td>{{i2.subdomain}}</td><td><img src="{{static_url('delete.png')}}" /></td></tr>
{% endfor %}
{% endfor %}
</tbody>
<tfooter>
	<tr>
		<th><input type="text" name="host" /></th>
		<th><input type="text" name="port" /></th>
		<th><input type="checkbox" name="subdomain" checked="checked" /></th>
		<th><input type="submit" value="Save" /></th>
	</tr>
</tfooter>
</table>
</form>
</div>
{% endblock %}